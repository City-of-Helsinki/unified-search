name: CI-sources

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  common:
    uses: City-of-Helsinki/.github/.github/workflows/ci-django-api.yml@ci_working_directory
    secrets: inherit
    with:
      python-version: 3.12
      postgres-major-version: 13
      working-directory: ./sources
      extra-commands: |
        # Start local OpenSearch for testing. It will be destroyed after the tests are done.
        # You can only log in to the Opensearch container from a runnable environment. 
        # The container is only for tests in this repository and only exists for the duration of the tests. 
        # For this reason, protecting the Opensearch admin password is not justified.
        docker run -d \
          --name opensearch \
          -p 9200:9200 \
          -p 9600:9600 \
          -e "discovery.type=single-node" \
          -e "plugins.security.disabled=true" \
          -e OPENSEARCH_INITIAL_ADMIN_PASSWORD='Very_Strong_Password_123456' \
          opensearchproject/opensearch:1.3.1
        
        echo 'ES_URI=http://localhost:9200' >> .env
        sudo apt-get install gdal-bin libsqlite3-mod-spatialite
        
        docker logs opensearch
