# Disclaimer:
#   Because pre-commit does not natively support monorepos this
#   configuration file is in the repository's root and contains
#   hooks for different parts of the monorepo.
#
# Pre-commit hook documentation:
# - https://pre-commit.com/
# - https://pre-commit.com/hooks.html
#
# Ruff pre-commit hook documentation:
# - https://github.com/astral-sh/ruff-pre-commit
default_language_version:
  python: python3.12

repos:
  #####################################################################
  # Hooks for `sources` directory / Python project
  #####################################################################
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.13.0  # <-- Should match sources/requirements-dev.txt's ruff version!
    hooks:
      # Run the linter only for sources directory
      - id: ruff-check
        args: [ --fix, --config, sources/pyproject.toml ]
        files: ^sources/
      # Run the formatter only for sources directory
      - id: ruff-format
        args: [ --config, sources/pyproject.toml ]
        files: ^sources/
  #####################################################################
  # Hooks for `graphql` directory / Node.js project
  #####################################################################
  # NOTE: Must install dependencies first! Run "yarn --cwd graphql"
  #
  # The invocations are a bit hacky here because of no monorepo support
  # in pre-commit. Removing the subdirectory prefix with a script is
  # mentioned as workaround in a pre-commit issue, see:
  # https://github.com/pre-commit/pre-commit/issues/1110#issuecomment-525937018
  - repo: local
    hooks:
      - id: eslint
        name: ESLint
        language: system
        entry: bash -lc 'graphql/strip-graphql-dir-prefix-from-args.sh "$@" | xargs -0 -r yarn --cwd graphql run eslint --fix'
        files: ^graphql/
        types_or: [ javascript, ts ]
      - id: prettier
        name: Prettier
        language: system
        entry: bash -lc 'graphql/strip-graphql-dir-prefix-from-args.sh "$@" | xargs -0 -r yarn --cwd graphql run prettier --write'
        files: ^graphql/
        types_or: [ javascript, ts, markdown, json, yaml ]
      - id: vitest-related
        name: Vitest related
        language: system
        # https://vitest.dev/guide/cli.html#vitest-related
        entry: bash -lc 'graphql/strip-graphql-dir-prefix-from-args.sh "$@" | xargs -0 -r yarn --cwd graphql run vitest related --run'
        files: ^graphql/
  #####################################################################
  # Shared hooks (i.e. for all parts of the monorepo)
  #####################################################################
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v4.2.0
    hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
        args: []
  - repo: https://github.com/jorisroovers/gitlint
    rev: v0.19.1
    hooks:
      - id: gitlint
        stages: [commit-msg]
  - repo: https://github.com/frnmst/md-toc
    rev: 9.0.0
    hooks:
      - id: md-toc
        # Skip first line to exclude topmost heading from Table of Contents
        args: ['--in-place', '--newline-string=\n', '--skip-lines=1', '--no-list-coherence', 'github']
